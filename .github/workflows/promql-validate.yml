name: PromQL Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-prometheus-config:
    name: Validate Prometheus Configuration
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Prometheus promtool
        run: |
          PROM_VERSION="2.48.0"
          wget -q https://github.com/prometheus/prometheus/releases/download/v${PROM_VERSION}/prometheus-${PROM_VERSION}.linux-amd64.tar.gz
          tar xzf prometheus-${PROM_VERSION}.linux-amd64.tar.gz
          sudo mv prometheus-${PROM_VERSION}.linux-amd64/promtool /usr/local/bin/
          promtool --version

      - name: Validate prometheus.yml
        run: |
          echo "Validating prometheus.yml..."
          promtool check config prometheus.yml
          echo "‚úÖ prometheus.yml is valid"

      - name: Validate prometheus-alerts.yml
        run: |
          echo "Validating prometheus-alerts.yml..."
          promtool check rules prometheus-alerts.yml
          echo "‚úÖ prometheus-alerts.yml is valid"

  validate-dashboard-promql:
    name: Validate Dashboard PromQL
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Extract and validate PromQL expressions
        run: |
          python3 << 'EOF'
          import json
          import os
          import re
          import sys

          dashboard_dir = "grafana/provisioning/dashboards"
          errors = []

          def extract_promql(obj, path=""):
              """Recursively extract PromQL expressions from dashboard JSON"""
              queries = []

              if isinstance(obj, dict):
                  # Check for expr field (PromQL query)
                  if 'expr' in obj and isinstance(obj['expr'], str):
                      queries.append((path, obj['expr']))

                  # Recursively process all values
                  for key, value in obj.items():
                      new_path = f"{path}.{key}" if path else key
                      queries.extend(extract_promql(value, new_path))

              elif isinstance(obj, list):
                  for i, item in enumerate(obj):
                      new_path = f"{path}[{i}]"
                      queries.extend(extract_promql(item, new_path))

              return queries

          def basic_promql_validation(expr):
              """Basic syntax validation for PromQL expressions"""
              if not expr or not isinstance(expr, str):
                  return True, "Empty or invalid expression"

              # Remove whitespace
              expr = expr.strip()
              if not expr:
                  return True, "Empty expression after stripping"

              # Check for balanced parentheses
              if expr.count('(') != expr.count(')'):
                  return False, "Unbalanced parentheses"

              # Check for balanced brackets
              if expr.count('[') != expr.count(']'):
                  return False, "Unbalanced brackets"

              # Check for balanced braces
              if expr.count('{') != expr.count('}'):
                  return False, "Unbalanced braces"

              return True, "OK"

          print("üîç Validating PromQL expressions in dashboards...\n")

          for filename in os.listdir(dashboard_dir):
              if not filename.endswith('.json'):
                  continue

              filepath = os.path.join(dashboard_dir, filename)
              print(f"Checking {filename}...")

              try:
                  with open(filepath, 'r') as f:
                      dashboard = json.load(f)

                  queries = extract_promql(dashboard)

                  if not queries:
                      print(f"  ‚ÑπÔ∏è  No PromQL expressions found")
                      continue

                  print(f"  Found {len(queries)} PromQL expression(s)")

                  for path, expr in queries:
                      valid, msg = basic_promql_validation(expr)
                      if not valid:
                          error = f"  ‚ùå Invalid PromQL at {path}: {msg}\n     Expression: {expr[:100]}"
                          print(error)
                          errors.append(error)
                      else:
                          # Just show first 80 chars of valid expressions
                          expr_preview = expr[:80] + "..." if len(expr) > 80 else expr
                          print(f"  ‚úÖ Valid: {expr_preview}")

              except json.JSONDecodeError as e:
                  error = f"  ‚ùå JSON parse error: {e}"
                  print(error)
                  errors.append(error)
              except Exception as e:
                  error = f"  ‚ùå Error processing file: {e}"
                  print(error)
                  errors.append(error)

              print()

          if errors:
              print(f"\n‚ùå Validation failed with {len(errors)} error(s)")
              sys.exit(1)
          else:
              print("‚úÖ All PromQL expressions validated successfully")
              sys.exit(0)
          EOF
