name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache: true
      
      - name: Download dependencies
        run: |
          cd shared/pkg
          go mod download
      
      - name: Run tests with race detector
        run: |
          cd shared/pkg
          go test -v -race -coverprofile=coverage.out ./models ./scheduler ./store
      
      - name: Generate coverage report
        run: |
          cd shared/pkg
          go tool cover -func=coverage.out | tail -1
      
      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: shared/pkg/coverage.out

  build-master:
    name: Build Master
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache: true
      
      - name: Build master binary
        run: |
          go build -v -o bin/master ./master/cmd/master
      
      - name: Verify binary
        run: |
          ./bin/master --version || echo "Master binary built successfully"
          ls -lh bin/master
      
      - name: Upload master binary
        uses: actions/upload-artifact@v4
        with:
          name: master-binary
          path: bin/master

  build-worker:
    name: Build Worker
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache: true
      
      - name: Build worker binary
        run: |
          go build -v -o bin/worker ./worker/cmd/agent
      
      - name: Verify binary
        run: |
          ./bin/worker --help || echo "Worker binary built successfully"
          ls -lh bin/worker
      
      - name: Upload worker binary
        uses: actions/upload-artifact@v4
        with:
          name: worker-binary
          path: bin/worker

  build-cli:
    name: Build CLI
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache: true
      
      - name: Build CLI binary
        run: |
          go build -v -o bin/ffrtmp ./cmd/ffrtmp
      
      - name: Verify binary
        run: |
          ./bin/ffrtmp --help
          ls -lh bin/ffrtmp
      
      - name: Upload CLI binary
        uses: actions/upload-artifact@v4
        with:
          name: ffrtmp-cli
          path: bin/ffrtmp
