[Unit]
Description=FFmpeg RTMP Compute Agent Service
Documentation=https://github.com/psantana5/ffmpeg-rtmp
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=ffmpeg
Group=ffmpeg
WorkingDirectory=/opt/ffmpeg-rtmp

# Environment: Set master URL
Environment="MASTER_URL=https://master.example.com:8080"
Environment="POLL_INTERVAL=10s"
Environment="HEARTBEAT_INTERVAL=30s"

# Start agent service
ExecStart=/opt/ffmpeg-rtmp/bin/agent \
    --register \
    --master ${MASTER_URL} \
    --poll-interval ${POLL_INTERVAL} \
    --heartbeat-interval ${HEARTBEAT_INTERVAL}

# Restart policy
Restart=always
RestartSec=10s
StartLimitBurst=5
StartLimitIntervalSec=300

# Resource limits
MemoryLimit=4G
MemoryAccounting=yes
CPUQuota=800%
CPUAccounting=yes

# Security hardening
NoNewPrivileges=true
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes
ReadWritePaths=/opt/ffmpeg-rtmp

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=ffmpeg-agent

# Graceful shutdown (allow time to finish current job)
TimeoutStopSec=600s
KillMode=mixed
KillSignal=SIGTERM

[Install]
WantedBy=multi-user.target
